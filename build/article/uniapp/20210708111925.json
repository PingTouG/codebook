{"title":"Uniapp极光推送常用方法封装","slug":"uniapp jpush","time":"2021-07-07T10:14:43.000Z","author":"PingTouG","html":"<p>常用方法封装是针对<code>Uniapp</code>插件市场中的极光官方的两个插件：<code>极光JPush官方SDK</code>、<code>极光JCore官方SDK</code>，关于安装请参考<a href=\"https://codebook.vercel.app/article/uniapp/20210707101348\">Uniapp对接极光推送</a></p>\n<p><code>jpush.js</code></p>\n<pre><code class=\"language-js\"><span class=\"hljs-regexp\">//</span> 工具类，导出环境判断\nimport { isDev,isIos } from <span class=\"hljs-string\">&#x27;./tools&#x27;</span>\n<span class=\"hljs-regexp\">//</span> vuex\nimport store from <span class=\"hljs-string\">&#x27;@/store&#x27;</span>\n<span class=\"hljs-regexp\">//</span> 本地缓存\nimport storage, { MESSAGE_TOTAL,USER_INFO } from <span class=\"hljs-string\">&#x27;./storage&#x27;</span>\n\n<span class=\"hljs-regexp\">//</span> <span class=\"hljs-comment\">#ifdef APP-PLUS</span>\nconst jv = uni.requireNativePlugin(<span class=\"hljs-string\">&#x27;JG-JPush&#x27;</span>)\n<span class=\"hljs-regexp\">//</span> <span class=\"hljs-comment\">#endif</span>\n\n<span class=\"hljs-regexp\">//</span> 不在App内提醒\nconst unAppToast = () =&gt; {\n    <span class=\"hljs-regexp\">//</span> <span class=\"hljs-comment\">#ifndef APP-PLUS</span>\n    isDev &amp;&amp; uni.showToast({\n        title:<span class=\"hljs-string\">&#x27;极光推送仅限APP内使用&#x27;</span>,\n        icon:<span class=\"hljs-string\">&#x27;none&#x27;</span>\n    })\n    <span class=\"hljs-regexp\">//</span> <span class=\"hljs-comment\">#endif</span>\n}\n<span class=\"hljs-regexp\">//</span> 初始化极光推送\nexport const jpushInit = () =&gt; {\n    <span class=\"hljs-regexp\">//</span> <span class=\"hljs-comment\">#ifdef APP-PLUS</span>\n    <span class=\"hljs-regexp\">//</span> 初始化\n    jv.initJPushService()\n    <span class=\"hljs-regexp\">//</span> 监听连接状态\n    jv.addConnectEventListener(result=&gt;{\n        <span class=\"hljs-keyword\">if</span>(result.connectEnable){\n            isDev &amp;&amp; console.log(<span class=\"hljs-string\">&#x27;连接极光推送成功&#x27;</span>)\n            const userinfo = storage.get(USER_INFO)\n            <span class=\"hljs-keyword\">if</span>(userinfo){\n                let total = <span class=\"hljs-number\">0</span>\n                <span class=\"hljs-regexp\">//</span> 在IOS下获取当前应用角标\n                <span class=\"hljs-keyword\">if</span>(isIos){\n                    const app = plus.ios.import(<span class=\"hljs-string\">&quot;UIApplication&quot;</span>).sharedApplication()\n                    total = app.applicationIconBadgeNumber()\n                }\n                \n                <span class=\"hljs-keyword\">if</span>(total === <span class=\"hljs-number\">0</span>){\n                    let total = storage.get(`<span class=\"hljs-variable\">${MESSAGE_TOTAL}</span>_<span class=\"hljs-variable\">${userinfo.id}</span>`)\n                    total = total ? total : <span class=\"hljs-number\">0</span>\n                }\n                store.commit(<span class=\"hljs-string\">&#x27;updateMessageTotal&#x27;</span>,total)\n                storage.set(`<span class=\"hljs-variable\">${MESSAGE_TOTAL}</span>_<span class=\"hljs-variable\">${userinfo.id}</span>`,total)\n            }\n        }\n    })\n    onNotification()\n    <span class=\"hljs-regexp\">//</span> <span class=\"hljs-comment\">#endif</span>\n    unAppToast()\n}\n<span class=\"hljs-regexp\">//</span> 监听消息推送\nconst onNotification = () =&gt; {\n    <span class=\"hljs-regexp\">//</span> <span class=\"hljs-comment\">#ifdef APP-PLUS</span>\n    jv.addNotificationListener(({badge,notificationEventType}) =&gt; {\n        <span class=\"hljs-regexp\">//</span> 收到新消息\n        <span class=\"hljs-keyword\">if</span>(notificationEventType === <span class=\"hljs-string\">&#x27;notificationArrived&#x27;</span>){\n            setBadge(badge)\n        }\n        <span class=\"hljs-regexp\">//</span> 点击打开消息\n        <span class=\"hljs-keyword\">if</span>(notificationEventType === <span class=\"hljs-string\">&#x27;notificationOpened&#x27;</span>){\n            <span class=\"hljs-regexp\">//</span> 此处是commit mutation，因为APP启动后会先加载首页，需要在首页加载完成之后才能跳转消息列表页，所以在这设置状态，在onLaunch中通过此状态判断是否需要跳转\n            store.commit(<span class=\"hljs-string\">&#x27;updateIsGoMessage&#x27;</span>,true)\n        }\n    })\n    <span class=\"hljs-regexp\">//</span> <span class=\"hljs-comment\">#endif</span>\n    unAppToast()\n}\n<span class=\"hljs-regexp\">//</span> 设置应用消息量角标\nexport const setBadge = (badge,isSyncData = true) =&gt; {\n    <span class=\"hljs-regexp\">//</span> <span class=\"hljs-comment\">#ifdef APP-PLUS</span>\n    plus.runtime.setBadgeNumber(badge)\n    jv.setBadge(badge)\n    <span class=\"hljs-keyword\">if</span>(isSyncData){\n        const userinfo = storage.get(USER_INFO)\n        storage.set(`<span class=\"hljs-variable\">${MESSAGE_TOTAL}</span>_<span class=\"hljs-variable\">${userinfo?.id}</span>`,badge)\n        store.commit(<span class=\"hljs-string\">&#x27;updateMessageTotal&#x27;</span>,badge)\n    }\n    <span class=\"hljs-regexp\">//</span> <span class=\"hljs-comment\">#endif</span>\n    unAppToast()\n}\n<span class=\"hljs-regexp\">//</span> 设置别名\nexport const setAlias = (alias) =&gt; {\n    <span class=\"hljs-regexp\">//</span> <span class=\"hljs-comment\">#ifdef APP-PLUS</span>\n    jv.setAlias({ alias })\n    <span class=\"hljs-regexp\">//</span> <span class=\"hljs-comment\">#endif</span>\n    unAppToast()\n}\n<span class=\"hljs-regexp\">//</span> 删除别名\nexport const removeAlias = () =&gt; {\n    <span class=\"hljs-regexp\">//</span> <span class=\"hljs-comment\">#ifdef APP-PLUS</span>\n    jv.deleteAlias()\n    <span class=\"hljs-regexp\">//</span> <span class=\"hljs-comment\">#endif</span>\n    unAppToast()\n}\n</code></pre>\n"}