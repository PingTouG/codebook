---
title: Uniapp极光推送常用方法封装
slug: uniapp jpush
time: 2021-7-7 10:14:43
author: PingTouG
---

常用方法封装是针对`Uniapp`插件市场中的极光官方的两个插件：`极光JPush官方SDK`、`极光JCore官方SDK`，关于安装请参考[Uniapp对接极光推送](https://codebook.vercel.app/article/uniapp/20210707101348)


`jpush.js`

```js
// 工具类，导出环境判断
import { isDev,isIos } from './tools'
// vuex
import store from '@/store'
// 本地缓存
import storage, { MESSAGE_TOTAL,USER_INFO } from './storage'

// #ifdef APP-PLUS
const jv = uni.requireNativePlugin('JG-JPush')
// #endif

// 不在App内提醒
const unAppToast = () => {
	// #ifndef APP-PLUS
	isDev && uni.showToast({
		title:'极光推送仅限APP内使用',
		icon:'none'
	})
	// #endif
}
// 初始化极光推送
export const jpushInit = () => {
	// #ifdef APP-PLUS
    // 初始化
	jv.initJPushService()
    // 监听连接状态
	jv.addConnectEventListener(result=>{
		if(result.connectEnable){
			isDev && console.log('连接极光推送成功')
			const userinfo = storage.get(USER_INFO)
			if(userinfo){
				let total = 0
                // 在IOS下获取当前应用角标
				if(isIos){
					const app = plus.ios.import("UIApplication").sharedApplication()
					total = app.applicationIconBadgeNumber()
				}
				
				if(total === 0){
					let total = storage.get(`${MESSAGE_TOTAL}_${userinfo.id}`)
					total = total ? total : 0
				}
				store.commit('updateMessageTotal',total)
				storage.set(`${MESSAGE_TOTAL}_${userinfo.id}`,total)
			}
		}
	})
	onNotification()
	// #endif
	unAppToast()
}
// 监听消息推送
const onNotification = () => {
	// #ifdef APP-PLUS
	jv.addNotificationListener(({badge,notificationEventType}) => {
		// 收到新消息
		if(notificationEventType === 'notificationArrived'){
			setBadge(badge)
		}
		// 点击打开消息
		if(notificationEventType === 'notificationOpened'){
            // 此处是commit mutation，因为APP启动后会先加载首页，需要在首页加载完成之后才能跳转消息列表页，所以在这设置状态，在onLaunch中通过此状态判断是否需要跳转
			store.commit('updateIsGoMessage',true)
		}
	})
	// #endif
	unAppToast()
}
// 设置应用消息量角标
export const setBadge = (badge,isSyncData = true) => {
	// #ifdef APP-PLUS
	plus.runtime.setBadgeNumber(badge)
	jv.setBadge(badge)
	if(isSyncData){
		const userinfo = storage.get(USER_INFO)
		storage.set(`${MESSAGE_TOTAL}_${userinfo?.id}`,badge)
		store.commit('updateMessageTotal',badge)
	}
	// #endif
	unAppToast()
}
// 设置别名
export const setAlias = (alias) => {
	// #ifdef APP-PLUS
	jv.setAlias({ alias })
	// #endif
	unAppToast()
}
// 删除别名
export const removeAlias = () => {
	// #ifdef APP-PLUS
	jv.deleteAlias()
	// #endif
	unAppToast()
}
```