<!DOCTYPE html> <html lang=en> <head> <meta charset=utf-8> <meta content="width=device-width,initial-scale=1" name=viewport> <meta content=#333333 name=theme-color> <base href=/ > <link href=assets/styles/global.css rel=stylesheet> <link href=manifest.json rel=manifest crossorigin=use-credentials> <link href=favicon.png rel=icon type=image/png> <script>__SAPPER__={baseUrl:"",preloaded:[void 0,{},{page:{title:"第三章：简单的数据库实现(源码)",slug:"Lisp",time:"2021-03-25T21:52:53.000Z",author:"PingTouG",html:"\u003Cp\u003E第二章是一个简单的数据库例子，通过编写一个 cd 信息的操作，来讲述知识点。\u003C\u002Fp\u003E\n\u003Cp\u003E主要设置的知识点：\u003C\u002Fp\u003E\n\u003Cul\u003E\n\u003Cli\u003E全局变量\u003C\u002Fli\u003E\n\u003Cli\u003E格式化输出\u003C\u002Fli\u003E\n\u003Cli\u003E列表的使用\u003C\u002Fli\u003E\n\u003Cli\u003E文件的读写\u003C\u002Fli\u003E\n\u003Cli\u003E宏\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\u003Cp\u003E源代码：\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"language-commonlisp\"\u003E\u003Cspan class=\"hljs-comment\"\u003E;;定义一个全局变量，用于存放数据\u003C\u002Fspan\u003E\n(\u003Cspan class=\"hljs-name\"\u003Edefvar\u003C\u002Fspan\u003E *db* \u003Cspan class=\"hljs-literal\"\u003Enil\u003C\u002Fspan\u003E)\n\n\u003Cspan class=\"hljs-comment\"\u003E;;制作一个CD需要的信息\u003C\u002Fspan\u003E\n(\u003Cspan class=\"hljs-name\"\u003Edefun\u003C\u002Fspan\u003E make-cd (\u003Cspan class=\"hljs-name\"\u003Etitle\u003C\u002Fspan\u003E artist rating ripped)\n  (\u003Cspan class=\"hljs-name\"\u003Elist\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-symbol\"\u003E:title\u003C\u002Fspan\u003E title \u003Cspan class=\"hljs-symbol\"\u003E:artist\u003C\u002Fspan\u003E artist \u003Cspan class=\"hljs-symbol\"\u003E:rating\u003C\u002Fspan\u003E rating \u003Cspan class=\"hljs-symbol\"\u003E:ripped\u003C\u002Fspan\u003E ripped))\n\n\u003Cspan class=\"hljs-comment\"\u003E;;将一条CD信息记录到全局变量中\u003C\u002Fspan\u003E\n(\u003Cspan class=\"hljs-name\"\u003Edefun\u003C\u002Fspan\u003E add-record (\u003Cspan class=\"hljs-name\"\u003Ecd\u003C\u002Fspan\u003E) (\u003Cspan class=\"hljs-name\"\u003Epush\u003C\u002Fspan\u003E cd *db*))\n\n\u003Cspan class=\"hljs-comment\"\u003E;;格式化输出数据\u003C\u002Fspan\u003E\n(\u003Cspan class=\"hljs-name\"\u003Edefun\u003C\u002Fspan\u003E dump-db ()\n  (\u003Cspan class=\"hljs-name\"\u003Eformat\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-literal\"\u003Et\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-string\"\u003E&quot;~{~{~A: ~10t~A~%~}~%~}&quot;\u003C\u002Fspan\u003E *db*))\n\n\u003Cspan class=\"hljs-comment\"\u003E;;交互信息\u003C\u002Fspan\u003E\n(\u003Cspan class=\"hljs-name\"\u003Edefun\u003C\u002Fspan\u003E prompt-read (\u003Cspan class=\"hljs-name\"\u003Eprompt\u003C\u002Fspan\u003E)\n  (\u003Cspan class=\"hljs-name\"\u003Eformat\u003C\u002Fspan\u003E *query-io* \u003Cspan class=\"hljs-string\"\u003E&quot;~A: &quot;\u003C\u002Fspan\u003E prompt)\n  (\u003Cspan class=\"hljs-name\"\u003Eforce-output\u003C\u002Fspan\u003E *query-io*)\n  (\u003Cspan class=\"hljs-name\"\u003Eread-line\u003C\u002Fspan\u003E *query-io*))\n\n\u003Cspan class=\"hljs-comment\"\u003E;;交互获取CD信息\u003C\u002Fspan\u003E\n(\u003Cspan class=\"hljs-name\"\u003Edefun\u003C\u002Fspan\u003E prompt-for-cd ()\n  (\u003Cspan class=\"hljs-name\"\u003Emake-cd\u003C\u002Fspan\u003E\n   (\u003Cspan class=\"hljs-name\"\u003Eprompt-read\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-string\"\u003E&quot;Title&quot;\u003C\u002Fspan\u003E)\n   (\u003Cspan class=\"hljs-name\"\u003Eprompt-read\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-string\"\u003E&quot;Artist&quot;\u003C\u002Fspan\u003E)\n   (\u003Cspan class=\"hljs-name\"\u003Eor\u003C\u002Fspan\u003E (\u003Cspan class=\"hljs-name\"\u003Eparse-integer\u003C\u002Fspan\u003E (\u003Cspan class=\"hljs-name\"\u003Eprompt-read\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-string\"\u003E&quot;Rating&quot;\u003C\u002Fspan\u003E) \u003Cspan class=\"hljs-symbol\"\u003E:junk-allowed\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-literal\"\u003Et\u003C\u002Fspan\u003E) \u003Cspan class=\"hljs-number\"\u003E0\u003C\u002Fspan\u003E)\n   (\u003Cspan class=\"hljs-name\"\u003Ey-or-n-p\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-string\"\u003E&quot;Ripped [y\u002Fn]: &quot;\u003C\u002Fspan\u003E)))\n\n\u003Cspan class=\"hljs-comment\"\u003E;;添加任意个CD信息\u003C\u002Fspan\u003E\n(\u003Cspan class=\"hljs-name\"\u003Edefun\u003C\u002Fspan\u003E add-cds ()\n  (\u003Cspan class=\"hljs-name\"\u003Eloop\u003C\u002Fspan\u003E (\u003Cspan class=\"hljs-name\"\u003Eadd-record\u003C\u002Fspan\u003E (\u003Cspan class=\"hljs-name\"\u003Eprompt-for-cd\u003C\u002Fspan\u003E))\n     (\u003Cspan class=\"hljs-name\"\u003Eif\u003C\u002Fspan\u003E (\u003Cspan class=\"hljs-name\"\u003Enot\u003C\u002Fspan\u003E (\u003Cspan class=\"hljs-name\"\u003Ey-or-n-p\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-string\"\u003E&quot;Another? [y\u002Fn]: &quot;\u003C\u002Fspan\u003E)) (\u003Cspan class=\"hljs-name\"\u003Ereturn\u003C\u002Fspan\u003E))))\n\n\u003Cspan class=\"hljs-comment\"\u003E;;将所有CD信息保存到文件中\u003C\u002Fspan\u003E\n(\u003Cspan class=\"hljs-name\"\u003Edefun\u003C\u002Fspan\u003E save-db (\u003Cspan class=\"hljs-name\"\u003Efilename\u003C\u002Fspan\u003E)\n  (\u003Cspan class=\"hljs-name\"\u003Ewith-open-file\u003C\u002Fspan\u003E (\u003Cspan class=\"hljs-name\"\u003Eout\u003C\u002Fspan\u003E filename\n               \u003Cspan class=\"hljs-symbol\"\u003E:direction\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-symbol\"\u003E:output\u003C\u002Fspan\u003E\n               \u003Cspan class=\"hljs-symbol\"\u003E:if-exists\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-symbol\"\u003E:supersede\u003C\u002Fspan\u003E)\n    (\u003Cspan class=\"hljs-name\"\u003Ewith-standard-io-syntax\u003C\u002Fspan\u003E\n      (\u003Cspan class=\"hljs-name\"\u003Eprint\u003C\u002Fspan\u003E *db* out))))\n\n\u003Cspan class=\"hljs-comment\"\u003E;;加载文件中的CD信息\u003C\u002Fspan\u003E\n(\u003Cspan class=\"hljs-name\"\u003Edefun\u003C\u002Fspan\u003E load-db (\u003Cspan class=\"hljs-name\"\u003Efilename\u003C\u002Fspan\u003E)\n  (\u003Cspan class=\"hljs-name\"\u003Ewith-open-file\u003C\u002Fspan\u003E (\u003Cspan class=\"hljs-name\"\u003Ein\u003C\u002Fspan\u003E filename)\n    (\u003Cspan class=\"hljs-name\"\u003Ewith-standard-io-syntax\u003C\u002Fspan\u003E\n      (\u003Cspan class=\"hljs-name\"\u003Esetf\u003C\u002Fspan\u003E *db* (\u003Cspan class=\"hljs-name\"\u003Eread\u003C\u002Fspan\u003E in)))))\n\u003Cspan class=\"hljs-comment\"\u003E;;通用查询\u003C\u002Fspan\u003E\n(\u003Cspan class=\"hljs-name\"\u003Edefun\u003C\u002Fspan\u003E select (\u003Cspan class=\"hljs-name\"\u003Eselector-fn\u003C\u002Fspan\u003E)\n  (\u003Cspan class=\"hljs-name\"\u003Eremove-if-not\u003C\u002Fspan\u003E selector-fn *db*))\n\n\u003Cspan class=\"hljs-comment\"\u003E;;根据artist查询\u003C\u002Fspan\u003E\n(\u003Cspan class=\"hljs-name\"\u003Edefun\u003C\u002Fspan\u003E artist-selector (\u003Cspan class=\"hljs-name\"\u003Eartist\u003C\u002Fspan\u003E)\n  #&#x27;(lambda (cd) (equal (getf cd :artist) artist)))\n\u003Cspan class=\"hljs-comment\"\u003E;;比较根据键比较值\u003C\u002Fspan\u003E\n(\u003Cspan class=\"hljs-name\"\u003Edefun\u003C\u002Fspan\u003E make-comparison-expr (\u003Cspan class=\"hljs-name\"\u003Efield\u003C\u002Fspan\u003E value)\n  `(equal (getf cd ,field) ,value))\n\u003Cspan class=\"hljs-comment\"\u003E;;循环比较\u003C\u002Fspan\u003E\n(\u003Cspan class=\"hljs-name\"\u003Edefun\u003C\u002Fspan\u003E make-comparisons-list (\u003Cspan class=\"hljs-name\"\u003Efields\u003C\u002Fspan\u003E)\n  (\u003Cspan class=\"hljs-name\"\u003Eloop\u003C\u002Fspan\u003E while fields\n     collecting (\u003Cspan class=\"hljs-name\"\u003Emake-comparison-expr\u003C\u002Fspan\u003E (\u003Cspan class=\"hljs-name\"\u003Epop\u003C\u002Fspan\u003E fields) (\u003Cspan class=\"hljs-name\"\u003Epop\u003C\u002Fspan\u003E fields))))\n\u003Cspan class=\"hljs-comment\"\u003E;;定义一个where宏\u003C\u002Fspan\u003E\n(\u003Cspan class=\"hljs-name\"\u003Edefmacro\u003C\u002Fspan\u003E where (\u003Cspan class=\"hljs-name\"\u003E&amp;rest\u003C\u002Fspan\u003E clauses)\n  `#&#x27;(lambda (cd) (and ,@(make-comparisons-list clauses))))\n\u003Cspan class=\"hljs-comment\"\u003E;;删除函数\u003C\u002Fspan\u003E\n(\u003Cspan class=\"hljs-name\"\u003Edefun\u003C\u002Fspan\u003E delete-rows (\u003Cspan class=\"hljs-name\"\u003Eselector-fn\u003C\u002Fspan\u003E)\n  (\u003Cspan class=\"hljs-name\"\u003Esetf\u003C\u002Fspan\u003E *db* (\u003Cspan class=\"hljs-name\"\u003Eremove-if\u003C\u002Fspan\u003E selector-fn *db*)))\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E在 eamcs 中使用 C-x C-f 新建一个文件，输入文件名之后回车。\u003C\u002Fp\u003E\n\u003Cp\u003E将上述源代码粘贴复制到此文件中，使用 C-x C-s 保存文件。\u003C\u002Fp\u003E\n\u003Cp\u003E保存完成之后，在 emacs 中使用 M-x 输入 slime 回车，启动 REPL(lisp 环境)。\u003C\u002Fp\u003E\n\u003Cp\u003E在 REPL 中输入：(load &quot;CD.lisp&quot;)回车，加载保存的文件。\u003C\u002Fp\u003E\n\u003Cp\u003E到这一步，则可使用上述源码中的所有函数，接下来进行测试。\u003C\u002Fp\u003E\n\u003Cp\u003E测试代码如下：\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"language-commonlisp\"\u003ECL-USER&gt; *db*\nNIL\nCL-USER&gt; (add-cds)\n\u003Cspan class=\"hljs-symbol\"\u003ETitle:\u003C\u002Fspan\u003E BangBom\n\u003Cspan class=\"hljs-symbol\"\u003EArtist:\u003C\u002Fspan\u003E Are\n\u003Cspan class=\"hljs-symbol\"\u003ERating:\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-number\"\u003E5\u003C\u002Fspan\u003E\n\n\nRipped [y\u002Fn]:  (y \u003Cspan class=\"hljs-keyword\"\u003Eor\u003C\u002Fspan\u003E n) y\n\n\nAnother? [y\u002Fn]:  (y \u003Cspan class=\"hljs-keyword\"\u003Eor\u003C\u002Fspan\u003E n) y\n\u003Cspan class=\"hljs-symbol\"\u003ETitle:\u003C\u002Fspan\u003E So happy\n\u003Cspan class=\"hljs-symbol\"\u003EArtist:\u003C\u002Fspan\u003E Bre\n\u003Cspan class=\"hljs-symbol\"\u003ERating:\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-number\"\u003E8\u003C\u002Fspan\u003E\n\n\nRipped [y\u002Fn]:  (y \u003Cspan class=\"hljs-keyword\"\u003Eor\u003C\u002Fspan\u003E n) n\n\n\nAnother? [y\u002Fn]:  (y \u003Cspan class=\"hljs-keyword\"\u003Eor\u003C\u002Fspan\u003E n) n\n\n\nNIL\nCL-USER&gt; (dump-db)\n\u003Cspan class=\"hljs-symbol\"\u003ETITLE:\u003C\u002Fspan\u003E    So happy\n\u003Cspan class=\"hljs-symbol\"\u003EARTIST:\u003C\u002Fspan\u003E   Bre\n\u003Cspan class=\"hljs-symbol\"\u003ERATING:\u003C\u002Fspan\u003E   \u003Cspan class=\"hljs-number\"\u003E8\u003C\u002Fspan\u003E\n\u003Cspan class=\"hljs-symbol\"\u003ERIPPED:\u003C\u002Fspan\u003E   NIL\n\n\n\u003Cspan class=\"hljs-symbol\"\u003ETITLE:\u003C\u002Fspan\u003E    BangBom\n\u003Cspan class=\"hljs-symbol\"\u003EARTIST:\u003C\u002Fspan\u003E   Are\n\u003Cspan class=\"hljs-symbol\"\u003ERATING:\u003C\u002Fspan\u003E   \u003Cspan class=\"hljs-number\"\u003E5\u003C\u002Fspan\u003E\n\u003Cspan class=\"hljs-symbol\"\u003ERIPPED:\u003C\u002Fspan\u003E   T\n\n\nNIL\nCL-USER&gt; (save-db \u003Cspan class=\"hljs-string\"\u003E&quot;CD.db&quot;\u003C\u002Fspan\u003E)\n((\u003Cspan class=\"hljs-symbol\"\u003E:TITLE\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-string\"\u003E&quot;So happy&quot;\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-symbol\"\u003E:ARTIST\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-string\"\u003E&quot;Bre&quot;\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-symbol\"\u003E:RATING\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-number\"\u003E8\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-symbol\"\u003E:RIPPED\u003C\u002Fspan\u003E NIL)\n (\u003Cspan class=\"hljs-symbol\"\u003E:TITLE\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-string\"\u003E&quot;BangBom&quot;\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-symbol\"\u003E:ARTIST\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-string\"\u003E&quot;Are&quot;\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-symbol\"\u003E:RATING\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-number\"\u003E5\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-symbol\"\u003E:RIPPED\u003C\u002Fspan\u003E T))\nCL-USER&gt; (select (where \u003Cspan class=\"hljs-symbol\"\u003E:title\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-string\"\u003E&quot;BangBom&quot;\u003C\u002Fspan\u003E))\n((\u003Cspan class=\"hljs-symbol\"\u003E:TITLE\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-string\"\u003E&quot;BangBom&quot;\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-symbol\"\u003E:ARTIST\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-string\"\u003E&quot;Are&quot;\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-symbol\"\u003E:RATING\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-number\"\u003E5\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-symbol\"\u003E:RIPPED\u003C\u002Fspan\u003E T))\nCL-USER&gt; (select (where \u003Cspan class=\"hljs-symbol\"\u003E:artist\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-string\"\u003E&quot;Bre&quot;\u003C\u002Fspan\u003E))\n((\u003Cspan class=\"hljs-symbol\"\u003E:TITLE\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-string\"\u003E&quot;So happy&quot;\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-symbol\"\u003E:ARTIST\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-string\"\u003E&quot;Bre&quot;\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-symbol\"\u003E:RATING\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-number\"\u003E8\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-symbol\"\u003E:RIPPED\u003C\u002Fspan\u003E NIL))\nCL-USER&gt; \n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n"}}]};if('serviceWorker' in navigator)navigator.serviceWorker.register('/service-worker.js');var s=document.createElement("script");try{new Function("if(0)import('')")();s.src="/client/client.ac5247b3.js";s.type="module";s.crossOrigin="use-credentials";}catch(e){s.src="/client/shimport@2.0.5.js";s.setAttribute("data-main","/client/client.ac5247b3.js")}document.head.appendChild(s)</script> <link href=client/client-5905f011.css rel=stylesheet><link href=client/_layout-8d114d53.css rel=stylesheet><link href=client/[...slug]-bb07c72b.css rel=stylesheet> <title>第三章：简单的数据库实现(源码)</title> <link href=/client/client.ac5247b3.js rel=modulepreload as=script crossorigin=use-credentials><link href=/client/client-5905f011.css rel=preload as=style><link href=/client/[...slug].9491a532.js rel=modulepreload as=script crossorigin=use-credentials><link href=/client/utils.302b01ae.js rel=modulepreload as=script crossorigin=use-credentials><link href=/client/inject_styles.5607aec6.js rel=modulepreload as=script crossorigin=use-credentials><link href=/client/[...slug]-bb07c72b.css rel=preload as=style></head> <body> <div id=sapper> <section class=svelte-r1sizb><header class=svelte-r1sizb><a href=./ ><img alt="code book logo" class="svelte-r1sizb logo" src=/assets/images/logo.png></a> <a href=https://github.com/PingTouG class="svelte-r1sizb github" target=_blank><i class="svelte-r1sizb icon-github iconfont"></i></a></header> <main><section><main class=svelte-he2wxq> <section class=md><h1 class=title>第三章：简单的数据库实现(源码)</h1> <div class="svelte-4z8ncs info"><div class="svelte-4z8ncs author">作者：PingTouG</div> <div class=time>时间：2021-03-25 21:52:53</div></div> <div class=md-content><p>第二章是一个简单的数据库例子，通过编写一个 cd 信息的操作，来讲述知识点。</p> <p>主要设置的知识点：</p> <ul> <li>全局变量</li> <li>格式化输出</li> <li>列表的使用</li> <li>文件的读写</li> <li>宏</li> </ul> <p>源代码：</p> <pre><code class=language-commonlisp><span class=hljs-comment>;;定义一个全局变量，用于存放数据</span>
(<span class=hljs-name>defvar</span> *db* <span class=hljs-literal>nil</span>)

<span class=hljs-comment>;;制作一个CD需要的信息</span>
(<span class=hljs-name>defun</span> make-cd (<span class=hljs-name>title</span> artist rating ripped)
  (<span class=hljs-name>list</span> <span class=hljs-symbol>:title</span> title <span class=hljs-symbol>:artist</span> artist <span class=hljs-symbol>:rating</span> rating <span class=hljs-symbol>:ripped</span> ripped))

<span class=hljs-comment>;;将一条CD信息记录到全局变量中</span>
(<span class=hljs-name>defun</span> add-record (<span class=hljs-name>cd</span>) (<span class=hljs-name>push</span> cd *db*))

<span class=hljs-comment>;;格式化输出数据</span>
(<span class=hljs-name>defun</span> dump-db ()
  (<span class=hljs-name>format</span> <span class=hljs-literal>t</span> <span class=hljs-string>"~{~{~A: ~10t~A~%~}~%~}"</span> *db*))

<span class=hljs-comment>;;交互信息</span>
(<span class=hljs-name>defun</span> prompt-read (<span class=hljs-name>prompt</span>)
  (<span class=hljs-name>format</span> *query-io* <span class=hljs-string>"~A: "</span> prompt)
  (<span class=hljs-name>force-output</span> *query-io*)
  (<span class=hljs-name>read-line</span> *query-io*))

<span class=hljs-comment>;;交互获取CD信息</span>
(<span class=hljs-name>defun</span> prompt-for-cd ()
  (<span class=hljs-name>make-cd</span>
   (<span class=hljs-name>prompt-read</span> <span class=hljs-string>"Title"</span>)
   (<span class=hljs-name>prompt-read</span> <span class=hljs-string>"Artist"</span>)
   (<span class=hljs-name>or</span> (<span class=hljs-name>parse-integer</span> (<span class=hljs-name>prompt-read</span> <span class=hljs-string>"Rating"</span>) <span class=hljs-symbol>:junk-allowed</span> <span class=hljs-literal>t</span>) <span class=hljs-number>0</span>)
   (<span class=hljs-name>y-or-n-p</span> <span class=hljs-string>"Ripped [y/n]: "</span>)))

<span class=hljs-comment>;;添加任意个CD信息</span>
(<span class=hljs-name>defun</span> add-cds ()
  (<span class=hljs-name>loop</span> (<span class=hljs-name>add-record</span> (<span class=hljs-name>prompt-for-cd</span>))
     (<span class=hljs-name>if</span> (<span class=hljs-name>not</span> (<span class=hljs-name>y-or-n-p</span> <span class=hljs-string>"Another? [y/n]: "</span>)) (<span class=hljs-name>return</span>))))

<span class=hljs-comment>;;将所有CD信息保存到文件中</span>
(<span class=hljs-name>defun</span> save-db (<span class=hljs-name>filename</span>)
  (<span class=hljs-name>with-open-file</span> (<span class=hljs-name>out</span> filename
               <span class=hljs-symbol>:direction</span> <span class=hljs-symbol>:output</span>
               <span class=hljs-symbol>:if-exists</span> <span class=hljs-symbol>:supersede</span>)
    (<span class=hljs-name>with-standard-io-syntax</span>
      (<span class=hljs-name>print</span> *db* out))))

<span class=hljs-comment>;;加载文件中的CD信息</span>
(<span class=hljs-name>defun</span> load-db (<span class=hljs-name>filename</span>)
  (<span class=hljs-name>with-open-file</span> (<span class=hljs-name>in</span> filename)
    (<span class=hljs-name>with-standard-io-syntax</span>
      (<span class=hljs-name>setf</span> *db* (<span class=hljs-name>read</span> in)))))
<span class=hljs-comment>;;通用查询</span>
(<span class=hljs-name>defun</span> select (<span class=hljs-name>selector-fn</span>)
  (<span class=hljs-name>remove-if-not</span> selector-fn *db*))

<span class=hljs-comment>;;根据artist查询</span>
(<span class=hljs-name>defun</span> artist-selector (<span class=hljs-name>artist</span>)
  #'(lambda (cd) (equal (getf cd :artist) artist)))
<span class=hljs-comment>;;比较根据键比较值</span>
(<span class=hljs-name>defun</span> make-comparison-expr (<span class=hljs-name>field</span> value)
  `(equal (getf cd ,field) ,value))
<span class=hljs-comment>;;循环比较</span>
(<span class=hljs-name>defun</span> make-comparisons-list (<span class=hljs-name>fields</span>)
  (<span class=hljs-name>loop</span> while fields
     collecting (<span class=hljs-name>make-comparison-expr</span> (<span class=hljs-name>pop</span> fields) (<span class=hljs-name>pop</span> fields))))
<span class=hljs-comment>;;定义一个where宏</span>
(<span class=hljs-name>defmacro</span> where (<span class=hljs-name>&rest</span> clauses)
  `#'(lambda (cd) (and ,@(make-comparisons-list clauses))))
<span class=hljs-comment>;;删除函数</span>
(<span class=hljs-name>defun</span> delete-rows (<span class=hljs-name>selector-fn</span>)
  (<span class=hljs-name>setf</span> *db* (<span class=hljs-name>remove-if</span> selector-fn *db*)))
</code></pre> <p>在 eamcs 中使用 C-x C-f 新建一个文件，输入文件名之后回车。</p> <p>将上述源代码粘贴复制到此文件中，使用 C-x C-s 保存文件。</p> <p>保存完成之后，在 emacs 中使用 M-x 输入 slime 回车，启动 REPL(lisp 环境)。</p> <p>在 REPL 中输入：(load "CD.lisp")回车，加载保存的文件。</p> <p>到这一步，则可使用上述源码中的所有函数，接下来进行测试。</p> <p>测试代码如下：</p> <pre><code class=language-commonlisp>CL-USER> *db*
NIL
CL-USER> (add-cds)
<span class=hljs-symbol>Title:</span> BangBom
<span class=hljs-symbol>Artist:</span> Are
<span class=hljs-symbol>Rating:</span> <span class=hljs-number>5</span>


Ripped [y/n]:  (y <span class=hljs-keyword>or</span> n) y


Another? [y/n]:  (y <span class=hljs-keyword>or</span> n) y
<span class=hljs-symbol>Title:</span> So happy
<span class=hljs-symbol>Artist:</span> Bre
<span class=hljs-symbol>Rating:</span> <span class=hljs-number>8</span>


Ripped [y/n]:  (y <span class=hljs-keyword>or</span> n) n


Another? [y/n]:  (y <span class=hljs-keyword>or</span> n) n


NIL
CL-USER> (dump-db)
<span class=hljs-symbol>TITLE:</span>    So happy
<span class=hljs-symbol>ARTIST:</span>   Bre
<span class=hljs-symbol>RATING:</span>   <span class=hljs-number>8</span>
<span class=hljs-symbol>RIPPED:</span>   NIL


<span class=hljs-symbol>TITLE:</span>    BangBom
<span class=hljs-symbol>ARTIST:</span>   Are
<span class=hljs-symbol>RATING:</span>   <span class=hljs-number>5</span>
<span class=hljs-symbol>RIPPED:</span>   T


NIL
CL-USER> (save-db <span class=hljs-string>"CD.db"</span>)
((<span class=hljs-symbol>:TITLE</span> <span class=hljs-string>"So happy"</span> <span class=hljs-symbol>:ARTIST</span> <span class=hljs-string>"Bre"</span> <span class=hljs-symbol>:RATING</span> <span class=hljs-number>8</span> <span class=hljs-symbol>:RIPPED</span> NIL)
 (<span class=hljs-symbol>:TITLE</span> <span class=hljs-string>"BangBom"</span> <span class=hljs-symbol>:ARTIST</span> <span class=hljs-string>"Are"</span> <span class=hljs-symbol>:RATING</span> <span class=hljs-number>5</span> <span class=hljs-symbol>:RIPPED</span> T))
CL-USER> (select (where <span class=hljs-symbol>:title</span> <span class=hljs-string>"BangBom"</span>))
((<span class=hljs-symbol>:TITLE</span> <span class=hljs-string>"BangBom"</span> <span class=hljs-symbol>:ARTIST</span> <span class=hljs-string>"Are"</span> <span class=hljs-symbol>:RATING</span> <span class=hljs-number>5</span> <span class=hljs-symbol>:RIPPED</span> T))
CL-USER> (select (where <span class=hljs-symbol>:artist</span> <span class=hljs-string>"Bre"</span>))
((<span class=hljs-symbol>:TITLE</span> <span class=hljs-string>"So happy"</span> <span class=hljs-symbol>:ARTIST</span> <span class=hljs-string>"Bre"</span> <span class=hljs-symbol>:RATING</span> <span class=hljs-number>8</span> <span class=hljs-symbol>:RIPPED</span> NIL))
CL-USER> 
</code></pre> </div> </section></main> </section></main> <div class="back-top svelte-1m03zpm" style=bottom:5rem;right:.625rem;display:none><i class="iconfont icon-back-top"></i> </div> </section></div> 